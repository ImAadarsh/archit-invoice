<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
  <!-- Meta Tags -->
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link rel="icon" type="image/jpg" href="invoicemate.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Endeavour Digital">
  <!-- Site Title -->
  <title>InvoiceMate Bulk Invoices</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    @media (max-width: 600px) {
      .tm_card_note {
        color: white !important;
      }
      #invoice_head {
        color: white !important;
      }
    }
    .page-break {
      page-break-after: always;
    }
    .tm_invoice_btns {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
      }
    
      @media print {
        .tm_hide_print {
          display: none !important;
        }
      }
      
      /* Fix for address section overlapping with table */
      .tm_invoice_head {
        position: relative;
        z-index: 1;
        margin-bottom: 20px !important;
        clear: both;
      }
      
      .tm_invoice_head p {
        margin-bottom: 5px;
        line-height: 1.6;
      }
      
      .tm_table {
        position: relative;
        z-index: 2;
        clear: both;
        margin-top: 20px;
      }
  </style>
</head>

<body>
  <div class="tm_container" id="invoices_container">
    <!-- Invoices will be dynamically inserted here -->
  </div>
  <div class="tm_hide_print" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button id="tm_print_bulk_btn" class="tm_color1" style="display: flex; align-items: center; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 5px rgb(68, 223, 12);">
      <span class="tm_btn_icon" style="margin-right: 10px;">
        <!-- Download icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
          <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
        </svg>
      </span>
      <span class="tm_btn_text"><b>Download Now</b></span>
    </button>
  </div>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jspdf.min.js"></script>
  <script src="assets/js/html2canvas.min.js"></script>
  <script>
    function amountToWords(amount) {
      const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
      const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
      
      function convertLessThanOneThousand(n) {
          if (n === 0) return '';
          if (n < 20) return units[n];
          const digit = n % 10;
          if (n < 100) return tens[Math.floor(n / 10)] + (digit ? " " + units[digit] : "");
          const digit2 = n % 100;
          return units[Math.floor(n / 100)] + " Hundred" + (digit2 ? " and " + convertLessThanOneThousand(digit2) : "");
      }
      
      function convertIndianSystem(n) {
          if (n === 0) return "Zero";
          
          // Handle numbers less than 1000
          if (n < 1000) return convertLessThanOneThousand(n);
          
          // Extract each denomination according to Indian numbering system
          const crore = Math.floor(n / 10000000);
          const lakh = Math.floor((n % 10000000) / 100000);
          const thousand = Math.floor((n % 100000) / 1000);
          const remaining = n % 1000;
          
          let result = "";
          
          if (crore > 0) {
              result += convertLessThanOneThousand(crore) + " Crore ";
          }
          
          if (lakh > 0) {
              result += convertLessThanOneThousand(lakh) + " Lakh ";
          }
          
          if (thousand > 0) {
              result += convertLessThanOneThousand(thousand) + " Thousand ";
          }
          
          if (remaining > 0) {
              result += convertLessThanOneThousand(remaining);
          }
          
          return result.trim();
      }
      
      // Parse the amount
      const parts = amount.toString().split('.');
      const wholePart = parseInt(parts[0]);
      let paisaPart = 0;
      
      // Handle paisa part correctly
      if (parts.length > 1) {
          // Ensure we only take first two digits for paisa
          const paisaStr = parts[1].padEnd(2, '0').substring(0, 2);
          paisaPart = parseInt(paisaStr);
      }
      
      // Convert whole part using Indian numbering system
      let result = convertIndianSystem(wholePart);
      
      // Add paisa part if exists
      if (paisaPart > 0) {
          result += " and " + convertLessThanOneThousand(paisaPart) + " Paisa";
      }
      
      return result + " Only/-";
    }
  
      function formatAddress(addressData, name, mobileNumber) {
        let formattedAddress = '';
  
        if (name) {
            formattedAddress += name + '<br>';
        }
  
        if (addressData) {
          const addressParts = [
              addressData.address_1,
              addressData.address_2,
              addressData.city,
              addressData.state,
              addressData.pincode
          ].filter(part => part && part !== 'null' && part.trim() !== '');
  
          formattedAddress += addressParts.join(', ') + '<br>';
        }
  
        if (mobileNumber) {
            formattedAddress += '<b>Mobile Number: </b>' + mobileNumber;
        }
  
        return formattedAddress;
      }

      $(document).ready(function() {
        // Parse IDs from the URL
        var urlParams = new URLSearchParams(window.location.search);
        var ids = urlParams.get('ids');
      
        if (!ids) {
          alert("No invoice IDs provided. Please select at least one invoice.");
          return;
        }
      
        var idsArray = ids.split(',').map(id => id.trim()).filter(id => id !== '');
      
        if (idsArray.length === 0) {
          alert("No valid invoice IDs provided. Please select at least one invoice.");
          return;
        }
      
        // Construct API URL
        var apiUrl = 'https://api.invoicemate.in/public/api/getBulkInvoicesSelected';
        
        // Fetch bulk invoice data
        $.ajax({
          url: apiUrl,
          type: 'POST', // Changed to POST to send data in the request body
          data: JSON.stringify({ ids: idsArray }),
          contentType: 'application/json',
          success: function(response) {
            if (response.status && response.data) {
              generateInvoices(response.data);
            } else {
              console.error('Invalid response structure:', response);
              alert("Error: Unable to retrieve invoice data. Please try again.");
            }
          },
          error: function(xhr, status, error) {
            console.error('Error fetching data from API:', error);
            alert("Error: Unable to retrieve invoice data. Please try again.");
          }
        });

      function generateInvoices(invoices) {
        var invoicesHtml = '';
        invoices.forEach(function(invoice, index) {
          invoicesHtml += generateInvoiceHtml(invoice, index);
          if (index < invoices.length - 1) {
            invoicesHtml += '<div class="page-break"></div>';
          }
        });
        $('#invoices_container').html(invoicesHtml);
      }

      function generateInvoiceHtml(invoice, index) {
        var goods_price = 0;
        var hasGST = false;

        if (invoice.items && invoice.items.length > 0) {
          hasGST = invoice.items.some(function(item) {
            return Number(item.gst_rate) > 0;
          });
        }

        if (!hasGST) {
          if ((Number(invoice.total_dgst) || 0) > 0 || (Number(invoice.total_cgst) || 0) > 0 || (Number(invoice.total_igst) || 0) > 0) {
            hasGST = true;
          }
        }

        var itemsHtml = generateItemsHtml(invoice.items, hasGST);
        var addressInfo = formatAddress(invoice.billing_address, invoice.name, invoice.mobile_number);
        
        // Calculate goods price
        if (invoice.items && invoice.items.length > 0) {
          invoice.items.forEach(function(item) {
            goods_price += item.quantity * item.price_of_one;
          });
        }

        // Prepare bank details
        var bankDetailsHtml = '';
        if (invoice.bank_details) {
          bankDetailsHtml = 'A/C Name: ' + invoice.bank_details.account_name + '<br>' +
                          invoice.bank_details.bank_name + ' ' + invoice.bank_details.address + '<br>' +
                          '<b>A/C No:</b> ' + invoice.bank_details.account_no + '<br>' +
                          'IFSC Code: ' + invoice.bank_details.ifsc_code;
        }

        // Get business logo
        var logoSrc = invoice.business_logo ? 'https://api.invoicemate.in/storage/app/' + invoice.business_logo : 'assets/img/invoice_mate.svg';

        // Get state GST label - try multiple sources
        var stateGstLabel = 'State GST';
        if (invoice.location_state) {
          stateGstLabel = invoice.location_state + ' GST';
        } else if (invoice.billing_address && invoice.billing_address.state) {
          stateGstLabel = invoice.billing_address.state + ' GST';
        } else if (invoice.business_info && invoice.business_info.state) {
          stateGstLabel = invoice.business_info.state + ' GST';
        }
        
        // Debug logging
        console.log('Invoice data:', invoice);
        console.log('State GST Label:', stateGstLabel);

        return `
          <div class="tm_invoice_wrap">
            <div class="tm_invoice tm_style1 tm_type1" id="tm_download_section_${index}">
              <div class="tm_invoice_in">
                <div class="tm_invoice_head tm_top_head tm_mb15 tm_align_center">
                  <div class="tm_invoice_left">
                    <div class="tm_logo"><img src="${logoSrc}" alt="Logo"></div>
                  </div>
                  <div class="tm_invoice_right tm_text_right business_location_data">
                    <p style="margin-top: 25px; font-size: 12px;" class="tm_black_color">
                      ${invoice.business_info.address || ''}<br>
                      <b>Ph. No: ${invoice.business_info.phone || ''}${invoice.business_info.alternate_phone ? ', ' + invoice.business_info.alternate_phone : ''}</b><br>
                      GSTIN: <b>${invoice.business_info.gst || ''}</b>
                    </p>
                  </div>
                </div>
                <div class="tm_invoice_info tm_mb25">
                  <div class="tm_card_note"><b class="tm_primary_color" id="invoice_head">Payment Method: </b> <span>${invoice.payment_mode || 'Not specified'}</span> <br>  <b class="tm_primary_color" id="invoice_head">Date: </b><span>${invoice.invoice_date ? new Date(invoice.invoice_date).toLocaleDateString() : 'Not specified'}</span> </div>
                  <div style="background-color: #1B5F92; padding-top: 14px; padding-bottom: 14px; padding-left: 40px; padding-right: 9px; border-top-left-radius: 8px; border-bottom-left-radius: 25px;" class="tm_invoice_info_list tm_white_color">
                    <p class="tm_invoice_number tm_m0">${invoice.serial_no ? 'Invoice No: #' + invoice.serial_no : 'Performa Invoice'}</p>
                    <p class="tm_invoice_date tm_m0">${invoice.doc_no ? 'GSTIN: #' + invoice.doc_no : 'GSTIN: Not Available'}</p>
                  </div>
                  <div class="tm_invoice_seperator tm_accent_bg"></div>
                </div>
                <div class="tm_invoice_head tm_mb10">
                  <div class="tm_invoice_left">
                    
                    <p class="tm_mb2"><b class="tm_primary_color">Ship To:</b></p>
                    <p id="billed_to_${index}">${addressInfo}</p>
                  </div>
                  <div class="tm_invoice_right tm_text_right">
                    <p id="" class="tm_mb2"><b class="tm_primary_color">Billed To:</b></p>
                    <p id="invoice_to_${index}">${addressInfo}</p>
                  </div>
                </div>
                <br>
                <div class="tm_table tm_style1">
                  <div class="">
                    <div class="tm_table_responsive">
                      <table>
                        <thead>
                          <tr class="tm_accent_bg">
                            <th class="tm_width_1 tm_semi_bold tm_white_color">Sno.</th>
                            <th class="tm_width_3 tm_semi_bold tm_white_color">Item Name</th>
                            ${hasGST ? '<th class="tm_width_2 tm_semi_bold tm_white_color tm_col_hsn">HSN</th>' : ''}
                            <th class="tm_width_1 tm_semi_bold tm_white_color">Quantity</th>
                            <th class="tm_width_2 tm_semi_bold tm_white_color">Rate</th>
                            ${hasGST ? '<th class="tm_width_1 tm_semi_bold tm_white_color tm_col_gst">GST Rate</th>' : ''}
                            <th class="tm_width_3 tm_semi_bold tm_white_color tm_text_right">Total Value</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${itemsHtml}
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="tm_invoice_footer tm_border_top tm_mb15 tm_m0_md">
                    <div class="tm_left_footer">
                      <p class="tm_mb2"><b class="tm_primary_color">Bank Details: </b></p>
                      <p class="tm_m0">${bankDetailsHtml}</p>
                      <br>
                      <table class="tm_mb15">
                        <tbody>
                          <tr class="tm_accent_bg">
                            <td style="background-color: #1B5F92; padding-top: 14px; padding-bottom: 14px; padding-left: 9px; padding-right: 40px; border-top-right-radius: 8px; border-bottom-right-radius: 25px; border: none; border-color: transparent !important; border-width: 0px !important;" class="tm_width_4 tm_border_top_0 tm_white_color"><b>Amount in Words:</b><br> <span>${amountToWords(invoice.total_amount || 0)}</span></td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    <div class="tm_right_footer">
                      <table class="tm_mb15">
                        <tbody>
                          <tr class="tm_gray_bg">
                            <td class="tm_width_3 tm_primary_color">Less Discount</td>
                            <td class="tm_width_3 tm_primary_color tm_text_right">0.00</td>
                          </tr>
                          <tr class="tm_gray_bg">
                            <td class="tm_width_3 tm_primary_color tm_bold">Total Value of Goods:</td>
                            <td class="tm_width_3 tm_primary_color tm_bold tm_text_right">${goods_price.toFixed(2)}</td>
                          </tr>
                          ${hasGST ? `
                          <tr class="tm_gray_bg gst-row">
                            <td class="tm_width_5 tm_primary_color">${stateGstLabel}</td>
                            <td class="tm_width_5 tm_primary_color tm_text_right">${(invoice.total_dgst || 0).toFixed(2)}</td>
                          </tr>
                          <tr class="tm_gray_bg gst-row">
                            <td class="tm_width_5 tm_primary_color">CGST</td>
                            <td class="tm_width_5 tm_primary_color tm_text_right">${(invoice.total_cgst || 0).toFixed(2)}</td>
                          </tr>
                          <tr class="tm_gray_bg gst-row">
                            <td class="tm_width_5 tm_primary_color">IGST</td>
                            <td class="tm_width_5 tm_primary_color tm_text_right">${(invoice.total_igst || 0).toFixed(2)}</td>
                          </tr>` : ''}
                          <tr class="tm_accent_bg">
                            <td class="tm_width_6 tm_border_top_0 tm_bold tm_white_color">Amount Chargeable</td>
                            <td class="tm_width_5 tm_border_top_0 tm_bold tm_white_color tm_text_right">${(invoice.total_amount || 0).toFixed(2)}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              <div class=" tm_text_center tm_font_style_normal">
                <hr class="">
                <p class="tm_m0 tm_primary_color">Â© Powered By Invoicemate - 2025</p>
              </div>
            </div>
          </div>
        `;
      }

      function generateItemsHtml(items, hasGST) {
        var itemsHtml = '';
        var totalRows = 20; // Maximum number of rows to display
        
        if (items && items.length > 0) {
          items.forEach(function(item, index) {
            var oneprice = item.quantity * item.price_of_one;
            var rowCells = [
              `<td class="tm_width_1">${index + 1}</td>`,
              `<td class="tm_width_3">${item.product ? item.product.name : 'Unknown Product'}</td>`
            ];

            if (hasGST) {
              rowCells.push(`<td class="tm_width_2">${item.product && item.product.hsn_code ? item.product.hsn_code : 'N/A'}</td>`);
            }

            rowCells.push(`<td class="tm_width_1">${item.quantity}</td>`);
            rowCells.push(`<td class="tm_width_2">${item.price_of_one.toFixed(2)}</td>`);

            if (hasGST) {
              var gstRate = Number(item.gst_rate) || 0;
              rowCells.push(`<td class="tm_width_1">${gstRate}%</td>`);
            }

            rowCells.push(`<td class="tm_width_3 tm_text_right">${oneprice.toFixed(2)}</td>`);

            itemsHtml += `<tr>${rowCells.join('')}</tr>`;
          });
          
          // Add empty rows to fill up to 20 rows total with sequential numbering
          var currentItemCount = items.length;
          for (var i = currentItemCount; i < totalRows; i++) {
            var emptyCells = [
              `<td class="tm_width_1">${i + 1}</td>`,
              '<td class="tm_width_3">&nbsp;</td>'
            ];

            if (hasGST) {
              emptyCells.push('<td class="tm_width_2">&nbsp;</td>');
            }

            emptyCells.push('<td class="tm_width_1">&nbsp;</td>');
            emptyCells.push('<td class="tm_width_2">&nbsp;</td>');

            if (hasGST) {
              emptyCells.push('<td class="tm_width_1">&nbsp;</td>');
            }

            emptyCells.push('<td class="tm_width_3 tm_text_right">&nbsp;</td>');

            itemsHtml += `<tr>${emptyCells.join('')}</tr>`;
          }
        } else {
          // If no items, add 20 empty rows with sequential numbering
          for (var i = 0; i < totalRows; i++) {
            var emptyCellsNoItems = [
              `<td class="tm_width_1">${i + 1}</td>`,
              '<td class="tm_width_3">&nbsp;</td>'
            ];

            if (hasGST) {
              emptyCellsNoItems.push('<td class="tm_width_2">&nbsp;</td>');
            }

            emptyCellsNoItems.push('<td class="tm_width_1">&nbsp;</td>');
            emptyCellsNoItems.push('<td class="tm_width_2">&nbsp;</td>');

            if (hasGST) {
              emptyCellsNoItems.push('<td class="tm_width_1">&nbsp;</td>');
            }

            emptyCellsNoItems.push('<td class="tm_width_3 tm_text_right">&nbsp;</td>');

            itemsHtml += `<tr>${emptyCellsNoItems.join('')}</tr>`;
          }
        }
        
        return itemsHtml;
      }
    
      $('#tm_print_bulk_btn').on('click', function() {
        window.print();
      });
    });
  </script>
</body>
</html>